subsystem = NFIRAOS
component = ism

description = ISM Assembly commands.

receive = [
 {
    name            = init
    description     = """Initialize the assembly and read configuration files. 

This command will internally trigger a stop if required. This command will also clear all ISM position offsets.

If configName and configVersion are not specified in the input, then the default configuration name and version will be used. If only configName is specified in the input, then the default version for the specified configName will be used. If only configVersion is specified in the input, then an error is returned.

*Simple Command.*

Precondition:
<ul>
<li> none
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
</ul>"""
    args = [
       {
        name        = configName 
        description = Name of the configuration file to get from the TMT Configuration Service
        type        = string
      }
      {
        name        = configVersion
        description = Version of the configuration file to get from the TMT Configuration Service
        type        = string 
      }
    ]

  }

{
    name            = datum
    description     = """Datum the ISM stages. 

This command will internally trigger a stop if required. This command will also clear all ISM position offsets.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
<li> state.select = UNKNOWN
<li> state.nsen = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.select = {default from config file}
</ul>"""
  }

  {
    name            = stop
    description     = """Cancel the current discrete type command and stop the ISM stages.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.select = BOTTOM | SIDE | TOP | INTERMEDIATE | UNKNOWN 
</ul>"""
  }

  {
    name            = move
    description     = """Engineering command to move the ISM stages to the specified position.
 
At least one argument must be specified. If the x or y input parameter is not specified, then the corresponding stage will not be moved. This command will also clear ISM position offset for the specified stage.

The ISM stages must be datumed otherwise this command will be rejected.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
<li> state.select = INTERMEDIATE
<li> state.nsen = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.select = BOTTOM | SIDE | TOP | INTERMEDIATE
</ul>"""
    args = [
      {
        name        = y
        description = target rotation about y-axis of ISM stage.
        type        = double
        units       = milliradian
        maximum     = 1658
        minimum     = -1658
      }
      {
        name        = x
        description = target rotation about x-axis of ISM stage.
        type        = double
        units       = milliradian
        maximum     = 5
        minimum     = -5 
      }
    ]
  }

  {
    name            = select
    description     = """Position the ISM to direct light to the NFIRAOS bottom, side or top port positions. 

If the NSEN flag is set then alternative port positions are used, which may be slightly offset from the nominally instrument bottom, side and top port positions. If the NSEN input parameter flag is not specified, then it will be set to false

If x or y offsets are specified, then these offset vales will be added to the selected port position. If the offset input parameters are not specified, then offset will be cleared (setting them to zero).   

The ISM stages must be datumed otherwise this command will be rejected.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
<li> state.select = INTERMEDIATE 
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.select = BOTTOM | SIDE | TOP
<li> state.nsen = {input nsen}
</ul>"""
    args = [
      {
        name        = select
        description = "Choice of either bottom, side or top port positions or one of the engineering bottom, side, or top positions.  Each top, side, and bottom 'positions' correspond to the equivalent top, side, and bottom port gates."
        enum        = [ BOTTOM, SIDE, TOP ] 
      }
      {
        name        = nsen
        description = "flag indicating whether alternative NSEN port positions should be used."
        type        = boolean 
      }
      {
        name        = yOffset
        description = rotation offset about y-axis of ISM stage relative to selected port position.
        type        = double
        units       = milliradian
        maximum     = 5
        minimum     = -5 
      }
      {
        name        = xOffset
        description = rotation offset about x-axis of ISM stage relative to  selected port position.
        type        = double
        units       = milliradian
        maximum     = 5
        minimum     = -5 
      }
    ]
    requiredArgs = [ select ]
  }

  {
    name            = debug
    description     = """Change the assembly debug message level.

The assembly will log all messages that correspond to the current debug message level as well as all lower levels (e.g. if the current debug message level is INFO, then all INFO, WARN and ERROR messages will be logged). Below are the debug message levels in descending order.
<ul>
<li>	\b DEBUG: extra details as messages are processed   
<li>	\b INFO : connections and command status
<li>	\b WARN(ing) : unexpected events/messages/etc
<li>	\b ERROR: failed to do something
</ul>

*Friendly Command.*
 
Precondition:
<ul>
<li> state.cmd = READY | BUSY
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | BUSY
<li> state.debug = {input debug}
</ul>"""
    args = [
      {
        name        = debug
        description = target debug level
        enum        = [ DEBUG, INFO, WARN, ERROR ] 
      }
    ]
    requiredArgs = [ debug ]
  }

 {
    name            = shutdown
    description     = """Shutdown the assembly.

This command is used to properly shutdown the assembly in preparation to turn off the NCC server.

*Simple Command.*
 
Precondition:
<ul>
<li> none
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = UNINITIALIZED
</ul>"""
  }

]

