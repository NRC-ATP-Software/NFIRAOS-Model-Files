subsystem = NFIRAOS
component = ism

description = ISM Assembly commands.

receive = [
 {
    name            = init
    description     = """Immediate Command.

Initialize the assembly and read configuration files. The configuration name must be specified if a configuration version is specified. This command will internally trigger a stop if required.

If configName and configVersion are not specified in the input, then the default configuration name and version will be used. If only configName is specified in the input, then the default version for the specified configName will be used. If only configVersion is specified in the input, then an error is returned.

Precondition:
<ul>
<li> none
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = UNDATUMED | DATUMED
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> offset.x = 0
<li> offset.y = 0
</ul>"""
    args = [
       {
        name        = configName 
        description = Name of the configuration file to get from the TMT Configuration Service
        type        = string
      }
      {
        name        = configVersion
        description = Version of the configuration file to get from the TMT Configuration Service
        type        = string 
      }
    ]

  }

{
    name            = datum
    description     = """Submit Command.

Datum the ISM stage and prepares. This command will internally trigger a stop if required.

This command will clear all ISM position offsets.

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = DATUMING
<li> state.select = UNKNOWN
<li> state.nsen = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = DATUMED
<li> state.select = {default from config file}
</ul>"""
  }

  {
    name            = stop
    description     = """Immediate Command.

Cancel the current submit type command and stop the ISM stage.

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = UNDATUMED | DATUMED
<li> state.select = BOTTOM | SIDE | TOP | INTERMEDIATE | UNKNOWN 
</ul>"""
  }

  {
    name            = move
    description     = """Submit Command.

Engineering command to move the ISM stage to the specified position.
 
At least one argument must be specified. If the x or y input parameter is not specified, then the corresponding stage will not be moved.

This command will clear all ISM position offsets.

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
<li> state.move = DATUMED | MOVING
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = MOVING
<li> state.select = INTERMEDIATE
<li> state.nsen = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = DATUMED
<li> state.select = BOTTOM | SIDE | TOP | INTERMEDIATE
</ul>"""
    args = [
      {
        name        = y
        description = target rotation about y-axis of ISM stage.
        type        = double
        units       = milliradian
        maximum     = 1658
        minimum     = -1658
      }
      {
        name        = x
        description = target rotation about x-axis of ISM stage.
        type        = double
        units       = milliradian
        maximum     = 5
        minimum     = -5 
      }
    ]
  }

  {
    name            = select
    description     = """Submit Command.

Position the ISM to direct light to the NFIRAOS bottom, side or top port positions. 

If the NSEN flag is set then alternative port positions are used, which may be slightly offset from the nominally instrument bottom, side and top port positions. If the NSEN input parameter flag is not specified, then it will be set to false

If x or y offsets are specified, then these offset vales will be added to the selected port position. If the offset input parameters are not specified, then offset will be cleared (setting them to zero).   

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
<li> state.move = DATUMED | MOVING
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = MOVING
<li> state.select = INTERMEDIATE 
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = DATUMED
<li> state.select = BOTTOM | SIDE | TOP
<li> state.nsen = {input nsen}
</ul>"""
    args = [
      {
        name        = select
        description = "Choice of either bottom, side or top port positions or one of the engineering bottom, side, or top positions.  Each top, side, and bottom 'positions' correspond to the equivalent top, side, and bottom port gates."
        enum        = [ BOTTOM, SIDE, TOP ] 
      }
      {
        name        = nsen
        description = "flag indicating whether alternative NSEN port positions should be used."
        type        = boolean 
      }
      {
        name        = yOffset
        description = rotation offset about y-axis of ISM stage relative to selected port position.
        type        = double
        units       = milliradian
        maximum     = 5
        minimum     = -5 
      }
      {
        name        = xOffset
        description = rotation offset about x-axis of ISM stage relative to  selected port position.
        type        = double
        units       = milliradian
        maximum     = 5
        minimum     = -5 
      }
    ]
    requiredArgs = [ select ]
  }

]

