subsystem = NFIRAOS
component = ngsSsm

description = NGS SSM Assembly commands.

receive = [

  {
    name            = init
    description     = """Prepares the assembly for operation and reads configuration files. 

This command will clear the tip/tilt/focus integrator and will also internally trigger a stop if required.

If configName and configVersion are not specified in the input, then the default configuration name and version will be used. If only configName is specified in the input, then the default version for the specified configName will be used. If only configVersion is specified in the input, then an error is returned.
 
*Simple Command.*

Precondition:
<ul>
<li> none
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.onTarget = true | false
<li> ssTarget.x = 0
<li> ssTarget.y = 0
</ul>"""
    args = [
       {
        name        = configName 
        description = Name of the configuration file to get from the TMT Configuration Service
        type        = string
      }
      {
        name        = configVersion
        description = Version of the configuration file to get from the TMT Configuration Service
        type        = string 
      }
    ]
  }
  
  {
    name            = datum
    description     = """Datum all the NGS SSM stages and resets the tip/tilt/focus integrator. 

This command will internally trigger a stop if required.
  
*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.ss = false
<li> state.onTarget = true
</ul>"""
  }

  {
    name            = stop
    description     = """Cancel the current discrete or following type command and stop all NGS SSM stages.
  
*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
</ul>"""
  }

  {
    name            = setDither
    description     = """Set or clear the telescope dither state, to inform the SSM the whether telescope is currently performing a dither or not. 

When the telescope is dithering the SSM assembly will change servo gains to stay locked on the guide star. This command does not stop the follow mode. If the timestamp parameter is not specified then the dither flag state change happens immediately.
 
*Simple Command.*
 
Precondition:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
<li> state.dither = true | false
</ul>"""
    args = [
      {
        name        = dither
        description = flag indicating if the telescope is currently dithering
        type        = boolean
      }
      {
        name        = time
        description = "timestamp indicating when the specified dither flag takes effect"
        type        = double
        units       = "TAI / PTP"
      }
    ]
    requiredArgs = [ dither ]
  }


  {
    name            = move
    description     = """Engineering command to move individual NGS SSM stages to the specified positions.

At least on input parameter must be specified, all unspecified stages will remain unchanged. The specified SSM stages must be datumed otherwise this command will be rejected.

*Discrete Command.*
  
Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.onTarget = true
</ul>"""
    args = [
      {
        name        = x
        description = target NGS SSM x-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
      {
        name        = y
        description = target NGS SSM y-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
      {
        name        = tip
        description = target NGS SSM tip-axis stage position.
        type        = double
        units       = "degrees in local stage coordinate system"
      }
      {
        name        = tilt
        description = target NGS SSM tilt-axis stage position.
        type        = double
        units       = "degrees in local stage coordinate system"
      }
      {
        name        = focus
        description = target NGS SSM focus-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
    ]
  }

  {
    name            = positionPwfs
    description     = """Position the PWFS based on the pointing model.

At least on input parameter must be specified, all unspecified stages will remain unchanged. All SSM stages must be datumed otherwise this command will be rejected.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
<li> state.onTarget = true
</ul>"""
    args = [
      {
        name        = imageX
        description = target NGS SSM x-axis image position.
        type        = double
        units       = "mm in FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = imageY
        description = target NGS SSM y-axis image position.
        type        = double
        units       = "mm in FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = pupilX
        description = target NGS SSM x-axis pupil offset.
        type        = double
        units       = "fraction of pupil diameter shift in FCRS<sub>174.5</sub>"
      }
      {
        name        = pupilY
        description = target NGS SSM y-axis pupil offset.
        type        = double
        units       = "fraction of pupil diameter shift in FCRS<sub>174.5</sub>"
      }
      {
        name        = focus
        description = target NGS SSM focus position.
        type        = double
        units       = "micrometers of RMS wavefront"
      }
    ]
  }

  {
    name            = setNssTarget
    description     = """Set the input PWFS position for following in SS mode. 

This position is used instead of the PWFS position stream from the TCS. This command does not actually move the SSM until the following in SS mode is enabled.
  
*Simple Command.*

Precondition:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
<li> ssTarget.x = {input x}
<li> ssTarget.y = {input y}
</ul>"""
    args = [
      {
        name        = x
        description = target in x for SS NGS source.
        type        = double
        units       = "mm in X-axis of FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = y
        description = target in y for SS NGS source.
        type        = double
        units       = "mm in Y-axis of FCRS<sub>174.5</sub> at reference wavelength"
      }
    ]
    requiredArgs = [ x, y ]
  }

  {
    name            = resetIntegrator
    description     = """Reset the tip/tilt/focus error integrator. 

This command does not stop the follow mode. It following this may cause the trackingError notable event to be raised, since there maybe a discontinuous jump in the target positions of the SSM stages.

*Simple Command.*
 
Precondition:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
<li> state.onTarget = true | false
</ul>"""
  }

  {
    name            = follow
    description     = """Enable the NGS SSM follow mode. 

When the follow mode is enabled, the NGS SSM will track the PWFS image position demands from the TCS, TTF errors from the RTC and the expected pupil shift stream from NGS ADC Assembly. 

If SS mode is enable, then the NGS SSM will not follow the PWFS image position stream from the TCS. Instead the image position will be set based on the image position set by the setNssTarget command and the ADC image shift stream from the NGS ADC Assembly. If the ss input parameter is not specified, then the SS mode will be disabled.
  
*Following Command.*

Precondition:                             
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = CONTINUOUS
<li> state.move = true | false
<li> state.ss = {input ss}
<li> state.onTarget = true 
</ul>"""
  args = [
      {
        name        = ss
        description = enable SS mode to operate with SS NGS Assembly
        type        = boolean
      }
    ]
  }

]

