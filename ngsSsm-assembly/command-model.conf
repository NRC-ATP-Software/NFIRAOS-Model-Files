subsystem = NFIRAOS
component = ngsSsm

description = NGS SSM Assembly commands.

receive = [

  {
    name            = init
    description     = """
    Request Command.

    Prepares the assembly for operation and reads configuration files. The configuration name must be specified if a configuration version is specified. This command will also clear the tip/tilt/focus integrator. This command will internally trigger a stop if required.

    If the configuration name is not specified, then a default configuration name and version is used. If the configuration version is not specified, then the default version is used for the specified configuration name.
<html>
  <p>
  Precondition:
  <ul>
  <li> none
  </ul>

  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  <li> state.move = unindexed | indexed
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready
  </ul>
</html>
    """
    args = [
       {
        name        = configuration name 
        description = Name of the configuration file to get from the TMT Configuration Service
        type        = string
      }
      {
        name        = configuration version
        description = Version of the configuration file to get from the TMT Configuration Service
        type        = string 
      }
    ]
  }
  
  {
    name            = datum
    description     = """
    Submit Command.

    Datum all the NGS SSM stages and resets the tip/tilt/focus integrator. This command will internally trigger a stop if required.
<html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd != uninitialized
  </ul>

  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  <li> state.move = indexing
  </ul>

  <p>  
  At Completion:
  <ul>
  <li> state.cmd = ready
  <li> state.move = indexed
  <li> state.nss = false
  <li> nssTarget.x/y = 0
  </ul>
</html>
    """
  }

  {
    name            = stop
    description     = """
    Request Command.

    Cancel the current submit type command and stop all NGS SSM stages.
<html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd != uninitialized
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready
  <li> state.move = unindexed | indexed
  </ul>
</html>
    """
  }

  {
    name            = setDither
    description     = """
    Request Command.

    Set or clear the telescope dither state, to inform the SSM the whether telescope is currently performing a dither or not. When the telescope is dithering the SSM assembly will change servo gains to stay locked on the guide star. This command does not stop the follow mode.
<html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd = ready | continuous | error
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready | continuous
  <li> state.dither = true | false
  </ul>
</html>
    """
  }


  {
    name            = move
    description     = """
    Submit Command.

    Engineering command to move individual NGS SSM stages to the specified positions.
<html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd != uninitialized
  <li> state.move = indexed | moving
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  <li> state.move = moving
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready
  <li> state.move = indexed
  </ul>
</html>
    """
    args = [
      {
        name        = x
        description = target NGS SSM x-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
      {
        name        = y
        description = target NGS SSM y-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
      {
        name        = tip
        description = target NGS SSM tip-axis stage position.
        type        = double
        units       = "degrees in local stage coordinate system"
      }
      {
        name        = tilt
        description = target NGS SSM tilt-axis stage position.
        type        = double
        units       = "degrees in local stage coordinate system"
      }
      {
        name        = focus
        description = target NGS SSM focus-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
    ]
  }

  {
    name            = positionPwfs
    description     = """
    Submit Command.

    Position the PWFS based on the pointing model.
<html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd != uninitialized
  <li> state.move = indexed | moving
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  <li> state.move = moving
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready
  <li> state.move = indexed
  </ul>
</html>
    """
    args = [
      {
        name        = imageX
        description = target NGS SSM x-axis image position.
        type        = double
        units       = "mm in FCRS174.5 at reference wavelength"
      }
      {
        name        = imageY
        description = target NGS SSM y-axis image position.
        type        = double
        units       = "mm in FCRS174.5 at reference wavelength"
      }
      {
        name        = pupilX
        description = target NGS SSM x-axis pupil position.
        type        = double
        units       = "fraction of pupil diameter shift in FCRS174.5"
      }
      {
        name        = pupilY
        description = target NGS SSM y-axis pupil position.
        type        = double
        units       = "fraction of pupil diameter shift in FCRS174.5"
      }
      {
        name        = focus
        description = target NGS SSM focus position.
        type        = double
        units       = "micrometers of RMS wavefront"
      }
    ]
  }


{
    name            = setNssTarget
    description     = """
    Submit Command.
  
    Set the input PWFS position for following in NSS mode. This position is used instead of the PWFS position stream from the TCS. This command does not actually move the SSM until the following in NSS mode is enabled.
<html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd != uninitialized
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> state.cmd = busy | continuous
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready | continuous
  <li> nssTarget.x/y =  &lt; input x/y position &gt;  
  </ul>
</html>
    """
    args = [
      {
        name        = x
        description = target in x for NSS NGS source.
        type        = double
        units       = "mm in X-axis of FCRS174.5 at reference wavelength"
      }
      {
        name        = y
        description = target in y for NSS NGS source.
        type        = double
        units       = "mm in Y-axis of FCRS174.5 at reference wavelength"
      }
    ]
  }

  {
    name            = resetIntegrator
    description     = """ 
    Request Command.

    Reset the tip/tilt/focus error integrator. This command does not stop the follow mode.
</html>
  <p>
  Precondition:
  <ul>
  <li> state.cmd = ready | continuous | error
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> state.cmd = busy
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = ready | continuous
  </ul>
</html>
    """
  }

  {
    name            = follow
    description     = """
    Request Command.

    Enable the NGS SSM follow mode. When the follow mode is enabled, the NGS SSM will track the PWFS image position demands from the TCS, TTF errors from the RTC and the expected pupil shift stream from NGS ADC Assembly. If NSS mode is enable, then the SSM will not follow the position stream from the TCS but instead use the position as set by setNssTarget command.
<html>
  <p>
  Precondition:                             
  <ul>
  <li> state.cmd != uninitialized
  <li> state.move = indexed | moving
  </ul>
  
  <p>
  Execution:
  <ul>
  <li> none
  </ul>

  <p>
  At Completion:
  <ul>
  <li> state.cmd = continuous
  <li> state.move = indexed | moving
  <li> status.nss =  &lt; input nss value  &gt;
  </ul>
</html>
  """
  args = [
      {
        name        = nss
        description = enable NSS mode to operate with NSS NGS Assembly
        type        = boolean
      }
    ]
  }

]

