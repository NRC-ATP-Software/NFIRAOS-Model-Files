subsystem = NFIRAOS
component = ngsSsm

description = NGS SSM Assembly commands.

receive = [

  {
    name            = init
    description     = """Immediate Command.

Prepares the assembly for operation and reads configuration files. The configuration name must be specified if a configuration version is specified. This command will also clear the tip/tilt/focus integrator. This command will internally trigger a stop if required.

If configName and configVersion are not specified in the input, then the default configuration name and version will be used. If only configName is specified in the input, then the default version for the specified configName will be used. If only configVersion is specified in the input, then an error is returned.
 
Precondition:
<ul>
<li> none
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = UNDATUMED | DATUMED
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.onTarget = true | false
<li> ssTarget.x = 0
<li> ssTarget.y = 0
</ul>"""
    args = [
       {
        name        = configName 
        description = Name of the configuration file to get from the TMT Configuration Service
        type        = string
      }
      {
        name        = configVersion
        description = Version of the configuration file to get from the TMT Configuration Service
        type        = string 
      }
    ]
  }
  
  {
    name            = datum
    description     = """Submit Command.

Datum all the NGS SSM stages and resets the tip/tilt/focus integrator. This command will internally trigger a stop if required.
  
Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = DATUMING
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = DATUMED
<li> state.ss = false
<li> state.onTarget = true
</ul>"""
  }

  {
    name            = stop
    description     = """Immediate Command.

Cancel the current submit type command and stop all NGS SSM stages.
  
Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = UNDATUMED | DATUMED
</ul>"""
  }

  {
    name            = setDither
    description     = """Immediate Command.

Set or clear the telescope dither state, to inform the SSM the whether telescope is currently performing a dither or not. When the telescope is dithering the SSM assembly will change servo gains to stay locked on the guide star. This command does not stop the follow mode.
  
Precondition:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
<li> state.dither = true | false
</ul>"""
    args = [
      {
        name        = dither
        description = flag indicating if the telescope is currently dithering
        type        = boolean
      }
      {
        name        = time
        description = "timestamp indicating when the specified dither flag takes effect"
        type        = double
        units       = "TAI / PTP"
      }
    ]
    requiredArgs = [ dither ]
  }


  {
    name            = move
    description     = """Submit Command.

Engineering command to move individual NGS SSM stages to the specified positions.

At least on input parameter must be specified, all unspecified stages will remain unchanged.
  
Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
<li> state.move = DATUMED | MOVING
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = MOVING
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = DATUMED
<li> state.onTarget = true
</ul>"""
    args = [
      {
        name        = x
        description = target NGS SSM x-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
      {
        name        = y
        description = target NGS SSM y-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
      {
        name        = tip
        description = target NGS SSM tip-axis stage position.
        type        = double
        units       = "degrees in local stage coordinate system"
      }
      {
        name        = tilt
        description = target NGS SSM tilt-axis stage position.
        type        = double
        units       = "degrees in local stage coordinate system"
      }
      {
        name        = focus
        description = target NGS SSM focus-axis stage position.
        type        = double
        units       = "mm in local stage coordinate system"
      }
    ]
  }

  {
    name            = positionPwfs
    description     = """Submit Command.

Position the PWFS based on the pointing model.

At least on input parameter must be specified, all unspecified stages will remain unchanged.

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
<li> state.move = DATUMED | MOVING
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = MOVING
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = DATUMED
<li> state.onTarget = true
</ul>"""
    args = [
      {
        name        = imageX
        description = target NGS SSM x-axis image position.
        type        = double
        units       = "mm in FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = imageY
        description = target NGS SSM y-axis image position.
        type        = double
        units       = "mm in FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = pupilX
        description = target NGS SSM x-axis pupil offset.
        type        = double
        units       = "fraction of pupil diameter shift in FCRS<sub>174.5</sub>"
      }
      {
        name        = pupilY
        description = target NGS SSM y-axis pupil offset.
        type        = double
        units       = "fraction of pupil diameter shift in FCRS<sub>174.5</sub>"
      }
      {
        name        = focus
        description = target NGS SSM focus position.
        type        = double
        units       = "micrometers of RMS wavefront"
      }
    ]
  }


{
    name            = setNssTarget
    description     = """Immediate Command.
  
Set the input PWFS position for following in SS mode. This position is used instead of the PWFS position stream from the TCS. This command does not actually move the SSM until the following in SS mode is enabled.
  
Precondition:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
<li> ssTarget.x = {input x}
<li> ssTarget.y = {input y}
</ul>"""
    args = [
      {
        name        = x
        description = target in x for SS NGS source.
        type        = double
        units       = "mm in X-axis of FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = y
        description = target in y for SS NGS source.
        type        = double
        units       = "mm in Y-axis of FCRS<sub>174.5</sub> at reference wavelength"
      }
    ]
    requiredArgs = [ x, y ]
  }

  {
    name            = resetIntegrator
    description     = """Immediate Command.

Reset the tip/tilt/focus error integrator. This command does not stop the follow mode.
  
Precondition:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
<li> state.onTarget = true | false
</ul>"""
  }

  {
    name            = follow
    description     = """Immediate Command.

Enable the NGS SSM follow mode. When the follow mode is enabled, the NGS SSM will track the PWFS image position demands from the TCS, TTF errors from the RTC and the expected pupil shift stream from NGS ADC Assembly. 

If SS mode is enable, then the NGS SSM will not follow the PWFS image position stream from the TCS. Instead the image position will be set based on the image position set by the setNssTarget command and the ADC image shift stream from the NGS ADC Assembly. If the ss input parameter is not specified, then the SS mode will be disabled.
  
Precondition:                             
<ul>
<li> state.cmd != UNINITIALIZED
<li> state.move = DATUMED | MOVING
</ul>
Execution:
<ul>
<li> none
</ul>
At Completion:
<ul>
<li> state.cmd = CONTINUOUS
<li> state.move = DATUMED | MOVING
<li> state.ss = {input ss}
<li> state.onTarget = true | false
</ul>"""
  args = [
      {
        name        = ss
        description = enable SS mode to operate with SS NGS Assembly
        type        = boolean
      }
    ]
  }

]

