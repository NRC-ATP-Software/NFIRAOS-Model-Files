subsystem = NFIRAOS
component = ngsFsm

description = NGS FSM Assembly commands.

receive = [
  
{
    name            = init
    description     = """Prepares the assembly for operation and read configuration files. 
This command will internally trigger a stop if required.

If configName and configVersion are not specified in the input, then the default configuration name and version will be used. If only configName is specified in the input, then the default version for the specified configName will be used. If only configVersion is specified in the input, then an error is returned.

*Simple Command.*
 
Precondition:
<ul>
<li> none
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = false
</ul>
At Completion:
<ul>
<li> state.cmd = READY
</ul>
    """
    args = [
       {
        name        = configName 
        description = Name of the configuration file to get from the TMT Configuration Service
        type        = string
      }
      {
        name        = configVersion
        description = Version of the configuration file to get from the TMT Configuration Service
        type        = string 
      }
    ]

  }
  
  {
    name            = datum
    description     = """Datum the NGS FSM stage. 

This command will internally trigger a stop if required.
  
*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
</ul>"""
  }

  {
    name            = stop
    description     = """Cancel the current discrete or following type command and stop the NGS FSM stages.
  
*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
</ul>"""
  }

  {
    name            = move
    description     = """Engineering command that moves the NGS FSM stage to the specified  position in units of mechanical rotation.
 
The NGS FSM stage must be datumed otherwise this command will be rejected and at least one input parameter must be specified, all unspecified stages will remain unchanged.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
<li> state.move = DATUMED | MOVING
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
</ul>"""
    args = [
      {
        name        = tip
        description = target NGS FSM tip stage position.
        type        = double
        units       = degrees of mechanical rotation in local stage coordinate system
      }
      {
        name        = tilt
        description = target NGS FSM tilt stage position.
        type        = double
        units       = degrees of mechanical rotation in local stage coordinate system
      }
    ]
  }

  {
    name            = position
    description     = """Engineering command that moves the NGS FSM stage to the specified position in units of image shift.

The NGS FSM stage must be datumed otherwise this command will be rejected.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = READY
<li> state.move = false
</ul>"""
    args = [
      {
        name        = x
        description = target NGS FSM x position
        type        = double
        units       = "mm in plane of FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = y
        description = target NGS FSM y position
        type        = double
        units       = "mm in plane of FCRS<sub>174.5</sub> at reference wavelength"
      }
    ]
    requiredArgs = [ x, y ]
  }


  {
    name            = follow
    description     = """Enable the NGS FSM follow mode. 

When the follow mode is enabled, the NGS FSM will follow the modulation and dither signal based on the specified inputs. If either the specified amplitude on frequency is zero, then the corresponding signal is signal is disabled.

At least modAmplitude and modPeriod, or ditherAmplitude, ditherPeriod and ditherSteps, or all five input parameters must be specified. 

If modAmplitude and modPeriod are not specified then modulation is not performed (state.modulation = false). 

Similarly if ditherAmplitude, ditherPeriod and ditherSteps are not specified then dithering is not performed (state.dither = false).
  
The NGS FSM stage must be datumed otherwise this command will be rejected.

*Following Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
<li> state.move = true
</ul>
At Completion:
<ul>
<li> state.cmd = CONTINUOUS
<li> state.move = true | false
<li> state.modulation = true | false
<li> state.dither = true | false
</ul>"""
  args = [
      {
        name        = modAmplitude 
        description = modulation signal amplitude
        type        = double
        units       = "mm in plane of FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = modPeriod
        description = number of trigger pulses per modulation signal period 
        type        = int
        units       = number of trigger pulses
        minimum     = 4
      }
      {
        name        = ditherAmplitude 
        description = dither signal amplitude
        type        = double
        units       = "mm in plane of FCRS<sub>174.5</sub> at reference wavelength"
      }
      {
        name        = ditherPeriod
        description = number of trigger pulses per dither signal period
        type        = int
        units       = number of trigger pulses
        minimum     = 16
      }
      {
        name        = ditherSteps
        description = number of steps per dither signal period. The ditherPeriod parameter must be divisible by this number.
        type        = int
        units       = number of trigger pulses
        minimum     = 4
      }

    ]
  }

]

